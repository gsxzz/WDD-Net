# YOLOv9

# parameters
nc: 8  # number of classes
depth_multiple: 1.0  # model depth multiple
width_multiple: 1.0  # layer channel multiple
#activation: nn.LeakyReLU(0.1)
#activation: nn.ReLU()

# anchors
anchors: 4

# YOLOv9 backbone
backbone:
  [
    [ -1, 1, Silence, [ ] ],

    # conv down
    [ -1, 1, Conv, [ 64, 3, 2 ] ],  # 1-P1/2

    # conv down
    [ -1, 1, Conv, [ 128, 3, 2 ] ],  # 2-P2/4

    # elan-1 block
    [ -1, 1, RepNCSPELAN4, [ 256, 128, 64, 1 ] ],  # 3

    # avg-conv down
    [ -1, 1, ADown, [ 256 ] ],  # 4-P3/8

    # elan-2 block
    [ -1, 1, RepNCSPELAN4, [ 512, 256, 128, 1 ] ],  # 5

    # avg-conv down
    [ -1, 1, ADown, [ 512 ] ],  # 6-P4/16

    # elan-2 block
    [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 7

    # avg-conv down
    [ -1, 1, ADown, [ 512 ] ],  # 8-P5/32

    # elan-2 block
    [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 9
  ]

# YOLOv9 head
head:
  [
     # elan-spp block
     [ -1, 1, SPPELAN, [ 512, 256 ] ],  # 10

     # up-concat merge
     [ -1, 1, nn.Upsample, [ None, 2, 'nearest' ] ],
     [ [ -1, 7 ], 1, Concat, [ 1 ] ],  # cat backbone P4

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 13

     # up-concat merge
     [ -1, 1, nn.Upsample, [ None, 2, 'nearest' ] ],
     [ [ -1, 5 ], 1, Concat, [ 1 ] ],  # cat backbone P3

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 256, 256, 128, 1 ] ],  # 16

     # up-concat merge
     [ -1, 1, nn.Upsample, [ None, 2, 'nearest' ] ],
     [ [ -1, 3 ], 1, Concat, [ 1 ] ],  # cat backbone P2

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 128, 128, 64, 1 ] ],  # 19 (P3/16-ssmall)

     # avg-conv-down merge
     [ -1, 1, ADown, [ 128 ] ],
     [ [ -1, 16 ], 1, Concat, [ 1 ] ],  # cat head P3

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 256, 256, 128, 1 ] ],  # 22 (P3/8-small)

     # avg-conv-down merge
     [ -1, 1, ADown, [ 256 ] ],
     [ [ -1, 13 ], 1, Concat, [ 1 ] ],  # cat head P4

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 25 (P4/16-medium)

     # avg-conv-down merge
     [ -1, 1, ADown, [ 512 ] ],
     [ [ -1, 10 ], 1, Concat, [ 1 ] ],  # cat head P5

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 28 (P5/32-large)


     # multi-level reversible auxiliary branch

     # routing
     [ 3, 1, CBLinear, [ [ 128 ] ] ], # 29
     [ 5, 1, CBLinear, [ [ 128,256 ] ] ], # 30
     [ 7, 1, CBLinear, [ [ 128,256, 512 ] ] ], # 31
     [ 9, 1, CBLinear, [ [ 128,256, 512, 512 ] ] ], # 32

     # conv down
     [ 0, 1, Conv, [ 64, 3, 2 ] ],  # 33-P1/2

     # conv down
     [ -1, 1, Conv, [ 128, 3, 2 ] ],  # 34-P2/4

     [ [ 29, 30, 31, 32, -1 ], 1, CBFuse, [ [ 0, 0, 0, 0 ] ] ], # 35

     # elan-1 block
     [ -1, 1, RepNCSPELAN4, [ 256, 128, 64, 1 ] ],  # 36

     # avg-conv down fuse
     [ -1, 1, ADown, [ 256 ] ],  # 37-P3/8
     [ [ 30, 31,32, -1 ], 1, CBFuse, [ [ 1, 1, 1 ] ] ], # 38

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 512, 256, 128, 1 ] ],  # 39

     # avg-conv down fuse
     [ -1, 1, ADown, [ 512 ] ],  # 40-P4/16
     [ [ 31, 32, -1 ], 1, CBFuse, [ [ 2, 2 ] ] ], # 41

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 42

     # avg-conv down fuse
     [ -1, 1, ADown, [ 512 ] ],  # 43-P5/32
     [ [ 32, -1 ], 1, CBFuse, [ [ 3 ] ] ], # 44

     # elan-2 block
     [ -1, 1, RepNCSPELAN4, [ 512, 512, 256, 1 ] ],  # 45

     # detection head
     # detect
     [ [ 36, 39, 42, 45, 19, 22, 25, 28 ], 1, DualDDetect, [ nc ] ],  # DualDDetect(A3, A4, A5, P3, P4, P5)
  ]
